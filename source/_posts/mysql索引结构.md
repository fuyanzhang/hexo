---
title: mysql索引结构
date: 2020-12-11 18:15:30
tags:
  - DB
  - mysql
  - 索引
categories:
  - DB
  - 技术
---

前段时间做了一些性能优化的工作，其中有些数据库优化的工作包含在里边。发现有些数据库的基础知识记忆有些模糊，这里简单的对数据库的基础知识做一些记录，加深印象。
这里以 mysql 为主进行说明。本篇笔记主要记录 mysql InnoDB 引擎的索引结构。

<!--more-->

# B 树与 B+树

我们知道，mysql 的 innoDB 引擎使用的索引底层数据结构是 B+树，而 B+树是 B 树的一个变体，我们这里从 B 树开始说。

## B 树

首先来个 B 树的定义：
B 树是一个多路查找平衡树，一个 m 阶 B 树（m 为每个节点最大的孩子节点数）满足如下要求：

- 1、每个节点最多有 m-1 个关键字
- 2、根节点最少有一个关键字
- 3、非根节点最多有 Math.ceil(m/2) -1 个关键字
- 4、每个节点上的关键字是按照从小到大的顺序排列，每个关键字的左子树的关键字都小于该关键字，右子树大于该关键字
- 5、所有的叶子节点在同一层
  B 树的结构如下：
  ![B树结构图](/images/B树.png)
  从结构图上可以看出，B 树的节点都是一样的，每个节点存放关键字和数据。

## B+树

B+树与 B 树类似，只是有其特殊性，B+树节点分为叶子节点和中间节点，叶子节点存放关键字和数据，中间节点只存放关键字。B+树叶子节点之间有指针进行连接，组成一个链表。
B+树的结构如下：
![B+树结构图](/images/B+树.png)

## InnoDB 引擎选择 B+树的原因

由于 B 树的节点都存放了数据，导致 B 树的每个节点占用的空间可能会很大，从而不能很好的使用 Linux 系统的文件缓存机制（操作系统的页存储机制），在查询过程中，可能会有多次磁盘的 IO 操作。而使用 B+树时，由于 B+树中间节点只有关键字，占用空间小，Linux 的一次 IO 可能会把大部分的关键字都放入到内存中，这样在查找过程中，可能会大大减少磁盘的 IO，提升查询效率。又由于 B+树的叶子节点之间组成一个链表，提升了范围查找的效率。

# InnoDB 的索引

### 聚集索引与辅助索引

mysql 的 InnoDB 引擎中的索引分为聚集索引和辅助索引。聚集索引就是我们常说的主键索引，辅助索引就是除主键索引的一般索引。辅助索引的叶子节点的数据并不是数据库的数据本身，而是主索引的索引关键字，就是说通过辅助索引查找数据，其实可能会查两个索引，先通过辅助索引获取主索引的关键字，然后通过主索引的关键字来查找具体的数据。所有索引都是 B+树结构。
一个例子来说明 innoDB 中的索引结构。
我们有如下用户表：

```
CREATE TABLE users(
    id INT NOT NULL,
    first_name VARCHAR(20) NOT NULL,
    last_name VARCHAR(20) NOT NULL,
    age INT NOT NULL,
    PRIMARY KEY(id),
    KEY(last_name, first_name, age),
    KEY(first_name)
);
```

其聚集索引结构如下：
![聚集索引](/images/聚集索引.png)
辅助索引跟聚集索引结构相同，不同之处在于，聚集索引叶子节点存放的是真实的数据，而辅助索引叶子节点存放的是聚集索引的的关键字。

### 联合索引

如上建表语句中`KEY(last_name, first_name, age)`就是一个联合索引。那么联合索引的结构是怎么样的呢？
联合索引也是辅助索引的一种，联合索引的中间节点存放的是各个关键字的合集，上面的例子中，中间节点存放的是`last_name`,`first_name`,`age`的值，其中`last_name `是按照顺序排列的，其他的只有`last_name`相同时，才会有顺序即小范围有序，这就解释了索引的最左匹配规则。叶子节点与辅助索引一样，存放的是聚集索引的关键字。

### 回表

回表的意思通俗的讲就是一次索引查询不能把所有的信息全部查到，需要回到聚集索引中查询表的其他的数据，相当于多了一次聚集索引的查询，可能会多一次 IO 操作。
引用网上的一个图：
![回表](/images/回表.png)
图中红色路径就是一次回表查询。
如果一次索引查询就能把所有的信息查到，就无需回表，减少了磁盘 IO。

# 后面

至此，索引优化相关的基础知识差不多就覆盖到了，优化的主要思路就是尽量减少磁盘的扫描。
